<!DOCTYPE html>
<html>

<head>
    <title>Gridline HOS Rejected Logs</title>
    <script>
        geotab.addin.GLHOSRejectedLogs = function (api, state) {
            var center = document.getElementById("center"),
                tableCreator = function (entities) {
                    var tableElement = document.createElement("TABLE");
                    var thead = document.createElement("THEAD");
                    var tbody = document.createElement("TBODY");
                    var tr = document.createElement("TR");

                    // Create "HOS Log Status" header
                    var th1 = document.createElement("TH");
                    th1.textContent = "HOS Log Status";
                    tr.appendChild(th1);

                    // Create "Username" header
                    var th2 = document.createElement("TH");
                    th2.textContent = "User/Driver";
                    tr.appendChild(th2);

                    // Create "Rejected Date" header
                    var th3 = document.createElement("TH");
                    th3.textContent = "Rejected Date (Recent First)";
                    tr.appendChild(th3);

                    // // Create "Made Historic" header
                    // var th4 = document.createElement("TH");
                    // th4.textContent = "Made Historic Date";
                    // tr.appendChild(th4);

                    // Append Completed Headers row to the table
                    thead.appendChild(tr);
                    tableElement.appendChild(thead);

                    // Sort entites before creating table rows in descending order (latest first)
                    entities.sort(function (a, b) {
                        var dateA = a.dateTime ? new Date(a.dateTime) : new Date(-8640000000000000);  //Earliest date in JS for no prop/no date
                        var dateB = b.dateTime ? new Date(b.dateTime) : new Date(-8640000000000000);
                        return dateB - dateA; // sort in descending order
                    });


                    // Create table rows and data entries out of API results object
                    entities.forEach(function (entity) {
                        // Create a new row for the entity
                        var tr = document.createElement("TR");

                        // Create "HOS Log Status" cell, if property doesnt exist on object, replace with N/A
                        //Will need to update this to the "parsed" Log status or limit entities coming in to only rejecteds
                        var tdLogStatus = document.createElement("TD");
                        tdLogStatus.setAttribute("data-id", entity.ID);
                        if (!entity.comment.includes('addedannotations') && entity.comment.includes('state:rejected')) { // Say Rejected or show full comment for now
                            tdLogStatus.textContent = "REJECTED HOS LOG";
                        } else {
                            tdLogStatus.textContent = entity.comment;
                        }
                        tr.appendChild(tdLogStatus);



                        // Create "UserName/Driver" cell with an attribute defined by its id for later
                        //this id will actually need to come from parsed ID out of audit comment section and go on the row or first column entry
                        var td = document.createElement("TD");
                        td.textContent = entity.userName;
                        tr.appendChild(td);



                        // Create dateTime cell, format example content "dateTime": "2015-02-12T22:40:57.522Z" to 02/12/2015 10:40:57 PM
                        var tddateTime = document.createElement("TD");
                        if (entity.dateTime) {
                            var dateTimeDate = new Date(entity.dateTime);
                            var dateFormatOptions = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' };
                            tddateTime.textContent = dateTimeDate.toLocaleDateString('en-us', dateFormatOptions).replace(',', '');
                        } else {
                            tddateTime.textContent = "N/A";
                        }
                        tr.appendChild(tddateTime);

                        // Create "Made Historic" cell, format example content "activeTo": "2015-02-12T22:40:57.522Z" to 02/12/2015 10:40:57 PM
                        // var tdActiveTo = document.createElement("TD");
                        // if (entity.activeTo) {
                        //     var activeToDate = new Date(entity.activeTo);
                        //     var dateFormatOptions = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' };
                        //     tdActiveTo.textContent = activeToDate.toLocaleDateString('en-us', dateFormatOptions).replace(',', '');
                        // } else {
                        //     tdActiveTo.textContent = "N/A";
                        // }
                        // tr.appendChild(tdActiveTo);


                        // Append Completed new row to the in progress table body
                        tbody.appendChild(tr);
                    });

                    // Append the completed output table body to the actual table element
                    tableElement.appendChild(tbody);

                    // Create a div element and add the now completed table to it
                    var divElement = document.createElement("DIV");
                    divElement.className = "de-responsive-table";
                    divElement.appendChild(tableElement);
                    return divElement;
                },
                goToHOSLogs = function (event) {
                    var id = event.target.getAttribute("data-id");
                    if (id) {
                        state.gotoPage("hosLog", {
                            id: id
                        });
                    }
                },
                refreshPage = function () {
                    api.call("Get", {
                        typeName: "Audit",
                        search: {
                            name: "HosLogEdit",
                            fromDate: "2024-02-01T05:00:00.000Z",
                            toDate: "2024-02-28T04:59:59.000Z"
                        },
                        resultsLimit: 10000
                    }, function (result) {

                        // Function for parsing Audit Log HOS items and fields
                        function extractValues(logString) {
                            try {
                                const idMatch = logString.match(/ID: ([\w\-]+)/);
                                const stateMatch = logString.match(/State: (\w+)/);
                                const statusMatch = logString.match(/Status: (\w+)/);
                                const eventRecordStatusMatch = logString.match(/EventRecordStatus: (\d+)/);
                                const driver = logString.match(/Driver: (\w+)/);
                                const timestamp = logString.match(/Timestamp: (\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z)/);


                                const extractResult = {
                                    ID: idMatch ? idMatch[1] : undefined,
                                    State: stateMatch ? stateMatch[1] : undefined,
                                    Status: statusMatch ? statusMatch[1] : undefined,
                                    EventRecordStatus: eventRecordStatusMatch ? parseInt(eventRecordStatusMatch[1], 10) : undefined,
                                    Driver: driver ? driver[1] : undefined,
                                    Timestamp: timestamp ? timestamp[1] : undefined
                                };

                                return extractResult;
                            } catch (error) {
                                console.error('Error parsing the log string', error);
                                return null;
                            }
                        }

                        // Add Eventer Listener to Parent Div to handle event delegation for any children in table with event.target.getAttribute("data-id") in listed function
                        center.addEventListener("click", goToHOSLogs, false);

                        // Filter HOS Results to just Rejected before passing into tableCreator using extractValues function above
                        let filteredResult = result
                            .filter(r => {
                                if (r.comment) {
                                    let comment = r.comment.toLowerCase().replaceAll(' ', '');
                                    return (!comment.includes('addedannotations')) && comment.includes('state:rejected');
                                }
                                return false; // If r.comment is undefined or null, do not include r in the filtered result
                            })
                            .map(r => {
                                let info = extractValues(r.comment);
                                if (info) {
                                    let {
                                        ID,
                                        State,
                                        Status,
                                        EventRecordStatus,
                                        Driver,
                                        Timestamp
                                    } = info;
                                    console.log(`Driver:${Driver}, Timestamp:${Timestamp}, HOS Log ID:${ID}, State:${State}, Status:${Status}, EventRecordStatus:${EventRecordStatus}`);
                                    return { ...r, ...info }; // Merge the properties of r and info
                                } else {
                                    console.log('Error extracting info from comment:', r.comment);
                                    return null;
                                }
                            });

                        center.appendChild(tableCreator(filteredResult));
                    }, function (error) {
                        console.log(error.message);
                    });
                },
                clearOnLeaving = function () {
                    center.removeEventListener("click", goToHOSLogs, false);
                    center.innerHTML = "";
                };

            return {
                initialize: function (api, state, callback) {
                    document.getElementById("de_HOSLogsButton")
                        .addEventListener("click", function () {
                            state.gotoPage("hosLogs");
                        }, false);
                    callback();
                },
                focus: function (api, state) {
                    refreshPage();
                },
                blur: function (api, state) {
                    clearOnLeaving();
                }
            }
        };
    </script>
</head>

<body>
    <div id="de-buttonContainer">
        <button id="de_HOSLogsButton" class="de-HOSLogs-button">Go to Geotab HOS Page</button>
    </div>
    <div id="center">

    </div>
    <link rel="stylesheet" href="GLHOSRejectedLogs.css">
</body>

</html>